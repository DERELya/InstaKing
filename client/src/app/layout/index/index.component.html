<div class="stories-wrapper">
  <div class="stories-scroll">
    <div class="story-item add-story" (click)="openCreateStoryDialog()">
      <div class="story-circle add-btn-circle">
        <mat-icon>add</mat-icon>
      </div>
      <span class="story-username">История</span>
    </div>

    <div
      *ngFor="let user of (usersWithStories$ | async); trackBy: trackByUsername"
      class="story-item"
      (click)="openStoryViewer(user.username)">

      <div class="story-circle" [ngClass]="{'has-story': !user.viewed, 'viewed': user.viewed}">
        <img [src]="user.avatarUrl" alt="story avatar" />
      </div>

      <span class="story-username">{{ user.username }}</span>
    </div>
  </div>
</div>

<div class="container feed-container">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6 feed-col">

      @if (isPostsLoaded) {
        @for (post of posts; track post.id; let i = $index) {
          <div class="post-card"> <div *ngIf="i === posts.length - 1" #anchor class="anchor-sentinel"></div>

            <div class="post-header">
              <div class="header-user" [routerLink]="['/profile/', post!.username]">
                <img *ngIf="post?.username"
                     [src]="post.avatarUrl || 'assets/placeholder.jpg'"
                     alt="avatar" class="avatar">
                <span class="username">{{ post!.username }}</span>
              </div>
            </div>

            <div class="post-title" *ngIf="post.title">{{ post.title }}</div>

            <div class="post-image-container" (dblclick)="likePost(post.id!, i)">
              <img *ngIf="post.image"
                   [src]="post.image"
                   class="feed-image"
                   alt="post image" />

              <div *ngIf="post.showHeart" class="heart-overlay">
                <mat-icon>favorite</mat-icon>
              </div>
            </div>

            <div class="post-footer">
              <section class="actions">
                <div class="actions-left">
                  <button mat-icon-button (click)="likePost(post!.id!, i)">
                    <mat-icon [class.liked-icon]="post!.isLiked">
                      {{ post!.isLiked ? 'favorite' : 'favorite_border' }}
                    </mat-icon>
                  </button>
                  <button mat-icon-button (click)="openPostDetails(i)">
                    <mat-icon>chat_bubble_outline</mat-icon>
                  </button>
                  <button mat-icon-button>
                    <mat-icon>send</mat-icon> </button>
                </div>
                <div class="actions-right">
                  <button mat-icon-button (click)="toggleFavorite(post.id!, i)">
                    <mat-icon [class.favorited-icon]="post!.favorited">
                      {{ post!.favorited ? 'bookmark' : 'bookmark_border' }}
                    </mat-icon>
                  </button>
                </div>
              </section>

              <section class="likes-section" *ngIf="post.usersLiked && post.usersLiked!.length > 0">
                <span class="likes-text">
                  Нравится <b>{{ post.usersLiked[0].username }}</b> <ng-container *ngIf="post.usersLiked.length > 1">
                     и <b class="others-link" (click)="openLikesDialog(i)">ещё {{ post.usersLiked.length - 1 }}</b>
                 </ng-container>
                </span>
              </section>

              <div class="comments-section">
                <button class="view-all-comments" (click)="openPostDetails(i)">
                  Посмотреть все комментарии ({{ post.commentCount }})
                </button>
              </div>

            </div>
          </div>
        }
      }

      <div class="load-more-container">
        <button class="btn-load"
                mat-stroked-button
                (click)="loadNextPage()"
                *ngIf="!noMorePosts"
                [disabled]="isLoading">
          Загрузить ещё
        </button>
        <div *ngIf="noMorePosts" class="no-more-text">
          На этом пока всё
        </div>
      </div>

    </div>
  </div>
</div>
