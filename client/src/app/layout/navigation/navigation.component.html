<mat-toolbar class="mat-toolbar">
  <!-- Логотип -->
  <div class="toolbar-section left">
    <a class="logo" routerLink="/main">InstaKing</a>
  </div>

  <!-- Центральная часть (Кнопки и Поиск) -->
  <div class="toolbar-section center" *ngIf="router.url.startsWith('/main')">

    <!-- 1. КНОПКА УВЕДОМЛЕНИЙ (Исправлено) -->
    <button mat-icon-button class="chat-btn" [matMenuTriggerFor]="notificationMenu"
            (menuOpened)="onMenuOpened()">
      <mat-icon
        [matBadge]="unreadCountNot$ | async"
        [matBadgeHidden]="(unreadCountNot$ | async) === 0"
        matBadgeColor="warn"
        matBadgeSize="medium"
        matBadgePosition="before"
        aria-hidden="false"
        aria-label="Уведомления">
        notifications
      </mat-icon>
    </button>

    <!-- Поиск -->
    <div class="search-container">
      <mat-form-field class="search-field" appearance="outline" floatLabel="always">
        <mat-icon matPrefix class="search-icon">search</mat-icon>
        <input matInput
               class="search-input"
               [(ngModel)]="query"
               (input)="searchUsers()"
               placeholder="Поиск"
               autocomplete="off"
               [matAutocomplete]="auto">
        <button mat-icon-button matSuffix *ngIf="query" (click)="clearSearch()" class="close-btn">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
    </div>

    <!-- Кнопка Direct -->
    <button mat-icon-button matSuffix (click)="openChat()" class="chat-btn">
      <mat-icon
        [matBadge]="unreadCount$ | async"
        [matBadgeHidden]="(unreadCount$ | async) === 0"
        matBadgeColor="warn"
        matBadgeSize="medium">
        send
      </mat-icon>
    </button>
  </div>

  <!-- Правая часть (Профиль) -->
  <div class="toolbar-section right">
    <ng-container *ngIf="!router.url.startsWith('/profile/'+user?.username)">
      <h3 *ngIf="isDataLoaded" class="username-text">{{ user?.username }}</h3>

      <!-- Меню профиля (оставляем #menu) -->
      <button *ngIf="isLoggedIn" [matMenuTriggerFor]="profileMenu" class="avatar-button">
        <img [src]="userProfileImage"
             alt="avatar"
             class="avatar-icon">
      </button>
    </ng-container>

    <div *ngIf="router.url.startsWith('/profile/'+user?.username)">
      <button mat-icon-button (click)="openSetting()">
        <mat-icon>settings_applications</mat-icon>
      </button>
    </div>

    <!-- МЕНЮ ПРОФИЛЯ -->
    <mat-menu #profileMenu="matMenu" class="my-custom-menu">
      <button mat-menu-item class="my-custom-menu-item" [routerLink]="['/profile/', user?.username]">
        <mat-icon>person_outline</mat-icon>
        <span>Profile</span>
      </button>
      <button mat-menu-item class="my-custom-menu-item" (click)="logout()">
        <mat-icon>logout</mat-icon> <span>Logout</span>
      </button>
    </mat-menu>
  </div>
</mat-toolbar>

<!-- Автокомплит поиска -->
<mat-autocomplete #auto="matAutocomplete" class="custom-autocomplete">
  <mat-option *ngFor="let user of users" (onSelectionChange)="goToProfile($event, user.username)">
    <div class="search-user-row">
      <img class="search-avatar" [src]="user.avatarUrl || 'assets/placeholder.jpg'" alt="avatar" />
      <div class="search-info">
        <span class="search-username">{{ user.username }}</span>
        <span class="search-fullname" *ngIf="user.firstname">{{ user.firstname }} {{ user.lastname }}</span>
      </div>
    </div>
  </mat-option>
</mat-autocomplete>


<!-- ============================================== -->
<!--        МЕНЮ УВЕДОМЛЕНИЙ (Новое имя #notificationMenu) -->
<!-- ============================================== -->
<mat-menu #notificationMenu="matMenu" class="notification-dropdown" xPosition="before">
  <div class="menu-container" (click)="$event.stopPropagation()">
    <div class="menu-header">
      <span class="header-title">Уведомления</span>
      <button mat-button color="primary" class="mark-all-btn"
              *ngIf="(unreadCountNot$ | async)! > 0"
              (click)="markAllRead()">
        Прочитать все
      </button>
    </div>

    <div class="notification-list">
      <div *ngIf="(notifications$ | async)?.length === 0" class="empty-state">
        <mat-icon>notifications_off</mat-icon>
        <p>Нет уведомлений</p>
      </div>

      <!-- Элемент уведомления -->
      <button mat-menu-item
              *ngFor="let item of notifications$ | async"
              class="notification-item"
              [class.unread]="!item.isRead"
              (click)="handleNotificationClick(item)">

        <div class="item-content">

          <!-- 1. ИКОНКА ТИПА (Маленькая, слева) -->
          <div class="type-icon-wrapper">
            <mat-icon *ngIf="item.type === 'LIKE'" class="icon-like">heart_plus</mat-icon>
            <mat-icon *ngIf="item.type === 'FOLLOW'" class="icon-follow">person_heart</mat-icon>
            <mat-icon *ngIf="item.type === 'COMMENT'" class="icon-comment">chat_bubble</mat-icon>
            <mat-icon *ngIf="item.type === 'SYSTEM'" class="icon-system">info</mat-icon>
          </div>

          <div class="sender-avatar-wrapper">
            <!-- ПРЯМОЙ ВЫЗОВ СЕРВИСА В ШАБЛОНЕ -->
            <img *ngIf="item.senderAvatarUrl"
                 [src]="item.senderAvatarUrl"
                 class="sender-avatar"
                 alt="avatar">

            <!-- Заглушка, если нет фото -->
            <div *ngIf="!item.senderAvatarUrl"
                 class="sender-avatar-placeholder"
                 [style.background-color]="getAvatarColor(item.senderUsername)">
              {{ item.senderUsername.slice(0,1).toUpperCase() }}
            </div>
          </div>

          <!-- 3. ТЕКСТОВЫЙ БЛОК -->
          <div class="text-wrapper">
            <div class="content-row">
              <span class="sender-name">{{ item.senderUsername }}</span>
              <span class="message-text">{{ item.content }}</span>
            </div>
            <span class="time-text">{{ item.createdAt | date:'shortTime' }}</span>
          </div>

          <!-- Синяя точка непрочитанного (справа) -->
          <div *ngIf="!item.isRead" class="unread-dot"></div>
        </div>
      </button>
    </div>
  </div>
</mat-menu>
