<div class="feed" *ngIf="isUserPostsLoaded">
  <mat-card class="ig-post" *ngFor="let post of posts; let i = index">
    <!-- Фото -->
    <img class="ig-photo"
         [src]="post.image"
         alt="photo"
         (click)="openPostDetails(i)" style="cursor: pointer;"/>
  </mat-card>
  <!-- Модальное окно поста на весь экран -->
  <div class="fullscreen-modal" *ngIf="openedPostIndex !== null" (click)="closePostDetails()">

    <div class="fullscreen-content" (click)="$event.stopPropagation()">
      <!-- Кнопка закрыть -->

      <div class="modal-img-block">
        <img class="modal-photo"
             [src]="posts[openedPostIndex!].image"
             alt="photo"/>
      </div>
      <div class="info-block">
        <div class="ig-modal-author-bar">
          <div class="ig-modal-author-info">
            <img [src]="getUserImage(posts[openedPostIndex!].username!)" alt="avatar" class="ig-modal-avatar">
            <span class="username">{{ posts[openedPostIndex!].username }}</span>
          </div>
          <div class="ig-modal-actions">
            <button class="dots-btn" (click)="toggleMenu()" aria-label="Меню">
              <!-- Современная svg три точки -->
              <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="4" cy="12" r="2" fill="#222"/>
                <circle cx="12" cy="12" r="2" fill="#222"/>
                <circle cx="20" cy="12" r="2" fill="#222"/>
              </svg>
            </button>
            <button class="close-btn" (click)="closePostDetails()" aria-label="Закрыть">
              <!-- SVG крестик -->
              <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                <path d="M10 10 L22 22 M22 10 L10 22" stroke="#222" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
            <div class="dots-menu" *ngIf="menuOpen">
              <button class="dots-menu-item delete" (click)="onMenuAction('delete')">
                <svg width="18" height="18" fill="none" style="vertical-align:middle;margin-right:8px;"><circle cx="9" cy="9" r="8" stroke="#e53935" stroke-width="2"/><path d="M9 5v4m0 2v2" stroke="#e53935" stroke-width="2" stroke-linecap="round"/></svg>
                Удалить пост
              </button>
              <button class="dots-menu-item" (click)="onMenuAction('update')">
                <svg width="18" height="18" fill="none" style="vertical-align:middle;margin-right:8px;"><rect x="4" y="4" width="10" height="10" rx="2" stroke="#1976d2" stroke-width="2"/><rect x="7" y="7" width="7" height="7" rx="1.5" stroke="#1976d2" stroke-width="1.5"/></svg>
                Редактировать пост
              </button>
            </div>
          </div>
        </div>
        <!-- ... -->
        <div class="comments-scrollable-block">
          @if (posts[openedPostIndex!]?.comments?.length) {
            <div style="text-align:left">
              <!-- Кнопка "Показать все" если комментов больше MAX_VISIBLE_COMMENTS -->

              <!-- Список комментариев -->
              <ng-container *ngIf="posts[openedPostIndex!].showAllComments; else lastComments">
                @for (comment of posts[openedPostIndex!].comments; track comment.id) {
                  <p>
                    <a [routerLink]="['/profile', comment.username]" class="profile-link"
                       (click)="closePostDetails()">
                      <img *ngIf="comment.username"
                           [src]="getUserImage(comment.username!)"
                           alt="avatar" class="ig-modal-avatar">
                      <span class="fw-bold">{{ comment.username }}</span>:{{ comment.message }}
                    </a>
                  </p>
                }
              </ng-container>
              <ng-container *ngIf="posts[openedPostIndex!].comments!.length > MAX_VISIBLE_COMMENTS">
                <button mat-button type="button"
                        (click)="toggleShowAllComments(openedPostIndex!)"
                        style="padding:0 0 8px 0;text-transform:none;color:#888;font-size:13px;">
                  @if (!posts[openedPostIndex!].showAllComments) {
                    Показать все комментарии ({{ posts[openedPostIndex!].comments!.length }})
                  } @else {
                    Скрыть комментарии
                  }
                </button>
              </ng-container>
              <ng-template #lastComments>
                @for (comment of posts[openedPostIndex!].comments!.slice(-MAX_VISIBLE_COMMENTS); track comment.id) {
                  <p>
                    <a [routerLink]="['/profile', comment.username]" class="profile-link"
                       (click)="closePostDetails()">
                      <img *ngIf="comment.username"
                           [src]="getUserImage(comment.username!)"
                           alt="avatar" class="ig-modal-avatar">
                      <span class="fw-bold">{{ comment.username }}</span>: {{ comment.message }}
                    </a>
                  </p>
                }
              </ng-template>
            </div>
          }
        </div>
        <div class="modal-info-block">
          <section class="actions">
            <div class="actions-horizontal">
              <button mat-icon-button (click)="likePost(posts[openedPostIndex!].id!, openedPostIndex!)">
                <mat-icon [ngClass]="{ liked: posts[openedPostIndex!].isLiked }">favorite</mat-icon>
              </button>
              <button mat-icon-button>
                <mat-icon>chat_bubble_outline</mat-icon>
              </button>
            </div>
            <button mat-icon-button>
              <mat-icon>bookmark_border</mat-icon>
            </button>
          </section>
          <section class="likes" *ngIf="posts[openedPostIndex].usersLiked && posts[openedPostIndex].usersLiked!.length > 0">
            <img
              [src]="getUserImage(posts[openedPostIndex].usersLiked![0])"
              alt="avatar" class="ig-modal-avatar">
            <span>{{ posts[openedPostIndex!].usersLiked![0] }}
              like{{ posts[openedPostIndex!].likes === 1 ? '' : 's' }}</span>
          </section>

          <form class="add-comment-form d-flex align-items-center" (submit)="postComment($event, commentInput.value, posts[openedPostIndex].id!, openedPostIndex)">
            <input #commentInput
                   matInput
                   class="form-control flex-grow-1"
                   placeholder="Комментарий..." required>
            <button mat-icon-button type="submit" class="send-btn ms-2" aria-label="Отправить комментарий">
              <mat-icon>send</mat-icon>
            </button>
          </form>
        </div>

        <time class="timestamp">{{ posts[openedPostIndex!].createdAt | date:'mediumDate' }}</time>
      </div>


    </div>
  </div>
</div>

