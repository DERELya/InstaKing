<div class="fullscreen-modal" (click)="close()">

  <div class="fullscreen-content" (click)="$event.stopPropagation()">
    <div class="modal-img-block">
      <img class="modal-photo"
           [src]="data.post.image"
           alt="photo"/>
    </div>

    <div class="info-block">
      <div>
        <div class="ig-modal-author-bar">
          <div class="ig-modal-author-info">

            <!-- 1. АВАТАР АВТОРА ПОСТА -->
            <!-- Используем уже готовую ссылку из UiPost (сделанную в PostService) -->
            <img [src]="data.post.avatarUrl || 'assets/placeholder.jpg'"
                 alt="avatar"
                 class="ig-modal-avatar">

            <span class="username">{{ data.post.username }}</span>
          </div>
          <!-- ... кнопки меню ... -->
          <div class="ig-modal-actions">
            <!-- ... -->
            <button class="close-btn" (click)="close()">✕</button>
          </div>
        </div>

        <span class="title">{{ data.post.caption }}</span>
        <!-- (исправил title на caption, обычно в постах caption) -->
      </div>

      <!-- КОММЕНТАРИИ -->
      <div class="comments-scrollable-block">
        <div *ngIf="comments.length > 0">
          <div style="text-align:left">
            <ng-container *ngFor="let comment of comments; trackBy: trackByCommentId">
              <div class="comment-item">
                <a [routerLink]="['/profile', comment.username]" class="profile-link" (click)="close()">

                  <!-- 2. АВАТАР КОММЕНТАТОРА -->
                  <img [src]="comment.avatarUrl || 'assets/placeholder.jpg'"
                       (error)="onAvatarError($event)"
                       alt="avatar" class="ig-modal-avatar">
                  <div class="comment-content">
                    <span class="fw-bold">{{ comment.username}}  </span>: {{ comment.message }}
                  </div>
                </a>
                <span class="comment-date">{{ comment.createdAt | timeAgo }}</span>

                <button *ngIf="comment.username === meUsername"
                        mat-icon-button
                        (click)="deleteComment(comment.id!)"
                        class="delete-comment-btn">
                  <mat-icon style="margin-left:-12px; font-size: 16px;">close</mat-icon>
                </button>
              </div>
            </ng-container>

            <button *ngIf="currentPage + 1 < totalPages && !loadingComments"
                    mat-button
                    (click)="loadNextPage()"
                    style="padding:0 0 8px 0;text-transform:none;color:#888;font-size:13px;">
              Показать ещё комментарии
            </button>
          </div>
        </div>
      </div>

      <!-- ЛАЙКИ И ДЕЙСТВИЯ -->
      <div class="modal-info-block">
        <section class="actions">
          <!-- ... кнопки лайка/сохранения ... -->
        </section>

        <section class="likes" *ngIf="data.post.usersLiked && data.post.usersLiked!.length > 0">
          <span class="likes-avatars">
            <ng-container *ngFor="let username of data.post.usersLiked!.slice(0, 3); let idx = index">
              <!--
                 ПРОБЛЕМА: Здесь у нас только username (строка).
                 Мы не знаем имя файла аватарки.
                 ВРЕМЕННО: Ставим заглушку.
                 ЧТОБЫ ИСПРАВИТЬ: Нужно чтобы бэк возвращал список объектов в usersLiked.
              -->
              <img [src]="'assets/placeholder.jpg'"
                   [style.z-index]="10 - idx"
                   [style.margin-left.px]="idx > 0 ? -12 : 0"
                   alt="avatar"
                   class="ig-modal-avatar like-avatar"/>
            </ng-container>
          </span>
          <span class="likes-label">
            Нравится <b>{{ data.post.usersLiked![0] }}</b>
            <ng-container *ngIf="data.post.usersLiked!.length > 1">
              и ещё <b><a class="like-username" (click)="openLikesDialog()"> {{ data.post.usersLiked!.length - 1 }} </a></b>
            </ng-container>
          </span>
        </section>

        <form class="add-comment-form d-flex align-items-center"
              (submit)="postComment($event, commentInput.value)">
          <input #commentInput matInput class="form-control flex-grow-1" placeholder="Комментарий..." required>
          <button mat-icon-button type="submit" class="send-btn ms-2">
            <mat-icon>send</mat-icon>
          </button>
        </form>
      </div>

      <time class="timestamp">{{ data.post.addedAt | date:'mediumDate' }}</time>
    </div>
  </div>
</div>
